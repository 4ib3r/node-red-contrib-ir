<script type="text/javascript">
    RED.nodes.registerType('banana-ir out',{
        category: "output",
        icon: "feed.png",
        color: "#FFAAAA",
        outputs: 1,
        defaults: {
            name:    { value: "" },
            debug: {value: false, required: true },
            keymap: {value: [], required: true }
        }, 
        label: function() {
            return this.name || "IrReceiver"
        },
        oneditprepare: function() {
            var $container = $("#node-input-keymap-container");
            function generateKeyMap(i, keymap) {
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top: 5px; text-align: right;"}).appendTo(container);
                 $('<i style="color: #eee; cursor: move;" class="node-input-keymap-handle fa fa-bars"></i>').appendTo(row);
                var keyField = $('<input/>',{style:"width:120px; margin-left: 5px; text-align: center;"}).appendTo(row);
                var valueField = $('<input/>',{class:"node-input-keymap-value",type:"text",style:"margin-left: 5px; width: 145px;"}).appendTo(row);
                var btwnField = $('<span/>').appendTo(row);
                var btwnValueField = $('<input/>',{class:"node-input-keymap-btwn-value",type:"text",style:"margin-left: 5px; width: 50px;"}).appendTo(btwnField);
                btwnField.append(" and ");
                var btwnValue2Field = $('<input/>',{class:"node-input-keymap-btwn-value2",type:"text",style:"width: 50px;margin-left:2px;"}).appendTo(btwnField);
                var finalspan = $('<span/>',{style:"float: right;margin-right: 10px;"}).appendTo(row);
                finalspan.append(' &#8594; <span class="node-input-keymap-index">'+i+'</span> ');
                var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"margin-top: 7px; margin-left: 5px;"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);
                selectField.change(function() {
                    var type = selectField.children("option:selected").val();
                    if (type.length < 4) {
                        selectField.css({"width":"60px"});
                    } else if (type === "regex") {
                        selectField.css({"width":"147px"});
                    } else {
                        selectField.css({"width":"120px"});
                    }
                    if (type === "btwn") {
                        valueField.hide();
                        btwnField.show();
                    } else {
                        btwnField.hide();
                        if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                            valueField.hide();
                        } else {
                            valueField.show();
                        }
                    }
                });
                deleteButton.click(function() {
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                        $container.children().each(function(i) {
                            $(this).find(".node-input-keymap-index").html(i+1);
                        });
                    });
                });
                $container.append(container);
            }
            $("#node-input-add-keymap").click(function() {
                generateRule($container.children().length+1,{t:"",v:"",v2:""});
                $("#node-input-keymap-container-div").scrollTop($("#node-input-keymap-container-div").get(0).scrollHeight);
            });
            for (var i=0;i<this.keymap.length;i++) {
                var key = this.keymap[i];
                generateKeymap(i+1, key);
            }

        },
        oneditsave: function() {
             var keymap = $("#node-input-keymap-container").children();
             var node = this;
             keymap.each(function(i) {
                node.keymap[keymap.find(".node-input-keymap-btwn-value").val()] = 
                    keymap.find(".node-input-keymap-btwn-value2").val();
             });
        }
    });
</script>

<script type="text/x-red" data-template-name="banana-ir out">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-debug"><i class="icon-info-circle"></i> Debug mode</label>
        <input type="checkbox" id="node-input-debug" placeholder="Debug">
    </div>
    <div class="form-row node-input-keymap-container-row" style="margin-bottom: 0px;">
        <div id="node-input-keymap-container-div" style="box-sizing: border-box; border-radius: 5px; height: 310px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
            <ol id="node-input-keymap-container" style="list-style-type:none; margin: 0;"></ol>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-keymap" style="margin-top: 4px;"><i class="fa fa-plus"></i>Add key</a>
    </div>
</script>

<script type="text/x-red" data-help-name="banana-ir out">
   <p>Node to use ir receiver in banana pi</p>
   <p>Outputs an object called <b>msg</b> containing
   <b>msg.payload</b>. msg.payload is a key code or mapped value if exists in configuration.</p>
</script>